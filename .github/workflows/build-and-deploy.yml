name: Build and Deploy to Devnet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with Docker
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            --user root \
            ghcr.io/coral-xyz/anchor-cli:0.30.1 \
            bash -c "
              set -ex
              
              # Show versions
              echo '=== Tool Versions ==='
              rustc --version
              cargo --version
              solana --version || echo 'Solana not in container'
              anchor --version
              
              # Install Solana if needed
              if ! command -v solana &> /dev/null; then
                echo 'Installing Solana...'
                sh -c \"\$(curl -sSfL https://release.anza.xyz/v2.0.18/install)\"
                export PATH=\"\$HOME/.local/share/solana/install/active_release/bin:\$PATH\"
              fi
              
              echo '=== Starting Build ==='
              anchor build --skip-lint 2>&1 | tee build.log || {
                echo '=== Build Failed ==='
                echo 'Build log:'
                cat build.log
                echo ''
                echo 'Trying cargo-build-sbf directly...'
                
                if command -v cargo-build-sbf &> /dev/null; then
                  cd programs/keystore
                  cargo-build-sbf --sbf-out-dir ../../target/deploy
                else
                  echo 'cargo-build-sbf not available, build failed'
                  exit 1
                fi
              }
              
              echo '=== Build Results ==='
              ls -lah target/deploy/ || echo 'No deploy directory'
              find target -name '*.so' -type f || echo 'No .so files found'
              
              # Fix permissions
              chmod -R 777 target/deploy/ || true
            "

      - name: Verify build output
        run: |
          echo "Checking for built files..."
          ls -lah target/deploy/ || echo "Deploy directory not found"
          
          if [ -f target/deploy/keystore.so ]; then
            echo "✓ Program built successfully!"
            ls -lh target/deploy/keystore.so
          else
            echo "✗ Program file not found"
            echo "Searching entire target directory:"
            find target -name "*.so" -type f 2>/dev/null || echo "No .so files anywhere"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: solana-program
          path: |
            target/deploy/*.so
            target/deploy/*.json
          retention-days: 30

      - name: Show deployment info
        if: success()
        run: |
          echo "==================================="
          echo "✓ BUILD SUCCESSFUL!"
          echo "==================================="
          echo ""
          echo "Download the 'solana-program' artifact above"
          echo ""
          echo "To deploy:"
          echo "  solana program deploy keystore.so"
          echo ""
          echo "Program ID:"
          cat target/deploy/keystore-keypair.json | grep -o '"[^"]*"' | head -1 || echo "See keypair file"
